name: Publish NuGet Packages

on:
  workflow_dispatch:
    inputs:
      buildRunId:
        description: "Run ID of the build workflow to download artifacts from"
        required: true
        type: string
      nugetApiKey:
        description: "NuGet API key (scoped to push packages)"
        required: true
        type: string

jobs:
  publish:
    if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' }}
    runs-on: windows-2022
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Download NuGet package artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: ICSharpCode.CodeConverter*.nupkg
        path: release-artifacts
        merge-multiple: true
        run-id: ${{ inputs.buildRunId }}

    - name: Publish NuGet packages
      shell: pwsh
      env:
        NUGET_API_KEY: ${{ inputs.nugetApiKey }}
      run: |
        Write-Output "::add-mask::$env:NUGET_API_KEY"
        $source = "https://api.nuget.org/v3/index.json"
        $packages = @(
          "release-artifacts/ICSharpCode.CodeConverter.*.nupkg",
          "release-artifacts/ICSharpCode.CodeConverter.CodeConv.*.nupkg"
        )
        foreach ($pattern in $packages) {
          Get-ChildItem -Path $pattern -File | ForEach-Object {
            dotnet nuget push $_.FullName -k $env:NUGET_API_KEY -s $source --skip-duplicate
          }
        }
